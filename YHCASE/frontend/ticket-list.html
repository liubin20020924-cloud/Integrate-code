<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工单系统 - 工单列表</title>
    <!-- 预加载关键资源 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 全局样式 - 贴合官网风格 */
        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", "微软雅黑", sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        /* 顶部导航 - logo左对齐，通栏白色背景 */
        .top-nav {
            width: 100%;
            height: 80px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 50px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 999;
        }
        .logo {
            height: 60px;
            object-fit: contain;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-name {
            color: #333;
            font-size: 14px;
        }
        .logout-btn {
            color: #f56c6c;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
        }
        .logout-btn:hover {
            color: #f78989;
        }
        .admin-only {
            display: none;
        }
        .admin-only.visible {
            display: block;
        }
        /* 主容器 - 避开顶部导航，居中留白 */
        .main-container {
            width: 100%;
            max-width: 1400px;
            margin: 100px auto 50px;
            padding: 0 20px;
        }
        /* 页面标题栏 + 操作按钮 */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaecef;
        }
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #222;
            margin: 0;
        }
        /* 筛选+表格卡片 - 白色背景、圆角、轻微阴影 */
        .content-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.03);
            padding: 30px;
        }
        /* 筛选框样式 */
        .filter-box {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        .filter-box .form-label {
            font-weight: 500;
            margin: 0;
        }
        .filter-box .form-select {
            width: 200px;
            border: 1px solid #dcdfe6;
            border-radius: 6px;
            height: 40px;
        }
        /* 表格样式 - 贴合官网，hover高亮 */
        .table {
            width: 100%;
            margin-bottom: 0;
        }
        .table thead {
            background-color: #f8f9fa;
        }
        .table thead th {
            border-bottom: 2px solid #eaecef;
            color: #666;
            font-weight: 600;
            padding: 12px 15px;
            text-align: left;
        }
        .table tbody td {
            border-bottom: 1px solid #f1f3f5;
            padding: 15px;
            vertical-align: middle;
        }
        .table tbody tr:hover {
            background-color: #fafbff;
        }
        /* 状态标签样式 */
        .status-tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-pending {
            background-color: #fff7e6;
            color: #e6a23c;
        }
        .status-processing {
            background-color: #e6f7ff;
            color: #409eff;
        }
        .status-completed {
            background-color: #f0f9eb;
            color: #67c23a;
        }
        .status-closed {
            background-color: #fef0f0;
            color: #f56c6c;
        }
        /* 优先级标签样式 */
        .priority-tag {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .priority-low {
            background-color: #f0f9eb;
            color: #67c23a;
        }
        .priority-medium {
            background-color: #e6f7ff;
            color: #409eff;
        }
        .priority-high {
            background-color: #fff7e6;
            color: #e6a23c;
        }
        .priority-urgent {
            background-color: #fef0f0;
            color: #f56c6c;
        }
        /* 按钮样式 - 贴合官网主色 */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        .btn-secondary {
            background-color: #f5f7fa;
            color: #666;
            border: 1px solid #dcdfe6;
        }
        .btn-secondary:hover {
            background-color: #eef2f7;
            color: #333;
            border-color: #c0c4cc;
        }
        .btn-info {
            background-color: #e6f7ff;
            color: #409eff;
            border: 1px solid #b3d8ff;
            padding: 6px 12px;
            font-size: 13px;
        }
        .btn-info:hover {
            background-color: #d5efff;
            border-color: #8cc5ff;
        }
        /* 空数据样式 */
        .empty-data {
            text-align: center;
            padding: 50px 0;
            color: #999;
            font-size: 14px;
        }
        /* 响应式适配 */
        @media (max-width: 768px) {
            .top-nav {
                padding: 0 20px;
                height: 70px;
            }
            .logo {
                height: 50px;
            }
            .main-container {
                margin-top: 90px;
            }
            .content-card {
                padding: 20px;
            }
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .filter-box {
                flex-direction: column;
                align-items: flex-start;
            }
            .filter-box .form-select {
                width: 100%;
                margin-top: 5px;
            }
            .table-responsive {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航 - 左上角logo -->
    <div class="top-nav">
        <img src="logo.png" alt="企业LOGO" class="logo">
        <div class="user-info">
            <span class="user-name" id="userName">未登录</span>
            <a href="login.html" class="logout-btn" onclick="logout()">退出登录</a>
        </div>
    </div>

    <!-- 主内容容器 -->
    <div class="main-container">
        <div class="content-card">
            <div class="page-header">
                <h2 class="page-title">工单列表</h2>
                <a href="submit-ticket.html" class="btn btn-secondary admin-only">返回提交工单</a>
            </div>

            <!-- 状态筛选 -->
            <div class="filter-box">
                <label class="form-label" for="statusFilter">工单状态：</label>
                <select class="form-select" id="statusFilter">
                    <option value="">全部状态</option>
                    <option value="pending">待处理</option>
                    <option value="processing">处理中</option>
                    <option value="completed">已完成</option>
                    <option value="closed">已关闭</option>
                </select>
            </div>

            <!-- 工单表格 -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>工单ID</th>
                            <th>工单标题</th>
                            <th>客户名称</th>
                            <th>产品</th>
                            <th>工单类型</th>
                            <th>优先级</th>
                            <th>工单状态</th>
                            <th>提交时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="ticketTableBody">
                        <!-- 动态渲染工单数据 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 异步加载Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script>
        const API_BASE = 'http://10.50.3.246:5000/api';

        // 统一的API请求封装 - 使用fetch with keep-alive优化
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                cache: 'no-cache'
            };
            return fetch(url, { ...defaultOptions, ...options });
        }
        let ticketList = [];

        // 页面加载完成后初始化
        window.onload = async () => {
            // 检查登录状态
            const userInfo = localStorage.getItem('userInfo');
            if (!userInfo) {
                alert('请先登录！');
                window.location.href = 'login.html';
                return;
            }

            // 解析用户信息并显示
            const user = JSON.parse(userInfo);
            document.getElementById('userName').textContent = user.username;

            // 根据角色显示/隐藏按钮
            if (user.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('visible'));
            }

            await loadTickets();
            bindFilterEvent();
        };

        // 登出
        function logout() {
            localStorage.removeItem('userInfo');
            window.location.href = 'login.html';
        }

        // 加载工单数据（支持状态筛选）
        async function loadTickets(status = '') {
            try {
                let requestUrl = `${API_BASE}/tickets`;
                if (status) requestUrl += `?status=${status}`;

                const res = await apiRequest(requestUrl);
                const result = await res.json();

                if (result.code === 200) {
                    ticketList = result.data;
                    renderTicketTable();
                } else {
                    alert(`查询失败：${result.msg}`);
                    renderTicketTable();
                }
            } catch (err) {
                console.error('查询异常：', err);
                alert('查询失败，请检查后端服务是否正常运行！');
                renderTicketTable();
            }
        }

        // 渲染工单表格
        function renderTicketTable() {
            const tableBody = document.getElementById('ticketTableBody');
            tableBody.innerHTML = '';

            // 空数据处理
            if (ticketList.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="empty-data">暂无工单数据</td></tr>`;
                return;
            }

            // 遍历渲染工单
            ticketList.forEach(ticket => {
                const tr = document.createElement('tr');
                // 状态标签样式映射
                let statusTag = '';
                switch (ticket.status) {
                    case 'pending': statusTag = '<span class="status-tag status-pending">待处理</span>'; break;
                    case 'processing': statusTag = '<span class="status-tag status-processing">处理中</span>'; break;
                    case 'completed': statusTag = '<span class="status-tag status-completed">已完成</span>'; break;
                    case 'closed': statusTag = '<span class="status-tag status-closed">已关闭</span>'; break;
                }
                // 工单类型格式化
                let typeText = '';
                switch (ticket.issue_type) {
                    case 'technical': typeText = '技术问题'; break;
                    case 'service': typeText = '服务咨询'; break;
                    case 'complaint': typeText = '投诉建议'; break;
                    case 'other': typeText = '其他问题'; break;
                }
                // 优先级格式化
                let priorityTag = '';
                switch (ticket.priority) {
                    case 'low': priorityTag = '<span class="priority-tag priority-low">低</span>'; break;
                    case 'medium': priorityTag = '<span class="priority-tag priority-medium">中</span>'; break;
                    case 'high': priorityTag = '<span class="priority-tag priority-high">高</span>'; break;
                    case 'urgent': priorityTag = '<span class="priority-tag priority-urgent">紧急</span>'; break;
                }

                tr.innerHTML = `
                    <td>${ticket.ticket_id}</td>
                    <td>${ticket.title}</td>
                    <td>${ticket.customer_name || '-'}</td>
                    <td>${ticket.product || '-'}</td>
                    <td>${typeText}</td>
                    <td>${priorityTag}</td>
                    <td>${statusTag}</td>
                    <td>${ticket.create_time}</td>
                    <td><a href="ticket-detail.html?id=${ticket.ticket_id}" class="btn btn-info">查看详情</a></td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // 绑定状态筛选事件
        function bindFilterEvent() {
            const filter = document.getElementById('statusFilter');
            filter.addEventListener('change', async (e) => {
                await loadTickets(e.target.value);
            });
        }
    </script>
</body>
</html>
