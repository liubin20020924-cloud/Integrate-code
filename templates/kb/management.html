<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>云户知识库管理系统 - 数据管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/edge_fixes.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <!-- 标题栏 -->
        <div class="header">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="logo-container">
                            <img src="{{ url_for('static', filename='image/Logo.jpg') }}" alt="云户知识库" class="logo-img">
                            <div>
                                <h1><i class="fas fa-tools me-2"></i>云户知识库管理系统 - 数据管理</h1>
                                <p class="lead mb-0">管理知识库数据</p>
                            </div>
                        </div>
                    </div>
                <div class="col-md-6 text-end">
                    <div class="d-flex align-items-center justify-content-end gap-3">
                        <!-- 用户信息 -->
                        {% if current_user %}
                        <div class="user-info">
                            <i class="fas fa-user-circle text-white me-2"></i>
                            <span class="fw-bold">{{ current_user.display_name or current_user.username }}</span>
                            <span class="badge bg-light text-dark ms-2">{{ current_user.role }}</span>
                        </div>
                        {% endif %}
                        
                        <!-- 操作按钮 -->
                        <div class="btn-group">
                            <a href="/" class="btn btn-light">
                                <i class="fas fa-home me-1"></i>返回首页
                            </a>
                            {% if current_user and current_user.role == 'admin' %}
                            <a href="/auth/users" class="btn btn-outline-light">
                                <i class="fas fa-users me-1"></i>用户管理
                            </a>
                            {% endif %}
                            <a href="/auth/logout" class="btn btn-outline-light">
                                <i class="fas fa-sign-out-alt me-1"></i>退出
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="row mb-3">
            <div class="col-md-2">
                <div class="stats-card bg-primary">
                    <h5><i class="fas fa-database me-2"></i>总记录数</h5>
                    <h3 id="totalCount">{{ total_count }}</h3>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card bg-success">
                    <h5><i class="fas fa-plus-circle me-2"></i>添加记录</h5>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addModal">
                        点击添加
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card bg-warning">
                    <h5><i class="fas fa-file-export me-2"></i>数据导出</h5>
                    <button id="exportData" class="btn btn-light btn-sm">
                        导出JSON
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card bg-danger">
                    <h5><i class="fas fa-trash-alt me-2"></i>批量删除</h5>
                    <button id="batchDeleteBtn" class="btn btn-light btn-sm" disabled>
                        批量操作
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card bg-info" id="debugStatusCard">
                    <h5><i class="fas fa-bug me-2"></i>调试模式</h5>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="debugModeSwitch" 
                               {% if debug_mode %}checked{% endif %}>
                        <label class="form-check-label" for="debugModeSwitch">
                            {{ '开启' if debug_mode else '关闭' }}
                        </label>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stats-card bg-secondary">
                    <h5><i class="fas fa-tools me-2"></i>系统工具</h5>
                    <button class="btn btn-light btn-sm" data-bs-toggle="dropdown">
                        工具菜单
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" id="showDebugInfo">
                            <i class="fas fa-info-circle me-2"></i>调试信息</a></li>
                        <li><a class="dropdown-item" href="#" id="checkSystemStatus">
                            <i class="fas fa-heartbeat me-2"></i>系统状态</a></li>
                        <li><a class="dropdown-item" href="#" id="systemCleanup">
                            <i class="fas fa-broom me-2"></i>系统清理</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="reloadPage">
                            <i class="fas fa-redo me-2"></i>重新加载</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 错误提示 -->
        {% if error %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- 操作按钮组 -->
        <div class="management-card">
            <div class="action-buttons mb-3">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
                    <i class="fas fa-plus me-1"></i>添加新记录
                </button>
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#batchAddModal">
                    <i class="fas fa-layer-group me-1"></i>批量添加
                </button>
                <button type="button" class="btn btn-success" id="reloadTable">
                    <i class="fas fa-sync-alt me-1"></i>刷新表格
                </button>
                <button type="button" class="btn btn-info" id="exportBtn">
                    <i class="fas fa-download me-1"></i>导出数据
                </button>
                <button type="button" class="btn btn-danger" id="deleteSelected" disabled>
                    <i class="fas fa-trash me-1"></i>删除选中
                </button>
                <button type="button" class="btn btn-warning" id="debugToolsBtn">
                    <i class="fas fa-bug me-1"></i>调试工具
                </button>
            </div>

            <!-- 数据表格 -->
            <div class="table-container">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th>编号</th>
                            <th>知识库名称</th>
                            <th>链接地址</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        {% for record in records %}
                        <tr data-id="{{ record.KB_Number }}">
                            <td>
                                <input type="checkbox" class="row-select" value="{{ record.KB_Number }}">
                            </td>
                            <td><strong>KB_{{ record.KB_Number }}</strong></td>
                            <td>{{ record.KB_Name }}</td>
                            <td>
                                {% if record.KB_link and record.KB_link != 'None' %}
                                    <a href="{{ record.KB_link }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>访问
                                    </a>
                                {% else %}
                                    <span class="text-muted">无链接</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-warning btn-edit" 
                                            data-id="{{ record.KB_Number }}"
                                            data-name="{{ record.KB_Name }}"
                                            data-link="{{ record.KB_link }}">
                                        <i class="fas fa-edit"></i> 编辑
                                    </button>
                                    <button class="btn btn-sm btn-danger btn-delete" 
                                            data-id="{{ record.KB_Number }}">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- 无数据提示 -->
            {% if not records %}
            <div class="no-records">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <h4>暂无数据</h4>
                <p>点击上方"添加新记录"按钮开始添加数据</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 添加记录模态框 -->
    <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>添加新记录</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addForm">
                        <div class="mb-3">
                            <label for="addKB_Number" class="form-label">知识库编号 *</label>
                            <input type="number" class="form-control" id="addKB_Number" 
                                   name="KB_Number" required placeholder="请输入数字编号">
                            <div class="form-text">主键，不能重复</div>
                        </div>
                        <div class="mb-3">
                            <label for="addKB_Name" class="form-label">知识库名称 *</label>
                            <input type="text" class="form-control" id="addKB_Name" 
                                   name="KB_Name" required placeholder="请输入知识库名称">
                        </div>
                        <div class="mb-3">
                            <label for="addKB_link" class="form-label">链接地址</label>
                            <input type="url" class="form-control" id="addKB_link" 
                                   name="KB_link" placeholder="http://或https://开头">
                            <div class="form-text">可选，请输入完整的URL地址</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitAdd">添加记录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量添加记录模态框 -->
    <div class="modal fade" id="batchAddModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-layer-group me-2"></i>批量添加记录</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>批量添加说明：</strong>
                                <ul class="mb-0 mt-2">
                                    <li>每行一条记录，使用逗号分隔</li>
                                    <li>格式：<code>知识库编号,知识库名称,链接地址(可选)</code></li>
                                    <li>示例：<code>1001,常见问题解答,https://example.com</code></li>
                                    <li>链接地址为空时可以省略</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">批量数据输入</label>
                        <textarea class="form-control" id="batchData" rows="10" 
                                  placeholder="输入多条记录，每行一条：
1001,常见问题解答,https://example.com/kb1001
1002,安装指南
1003,故障排除,https://example.com/kb1003"></textarea>
                        <div class="form-text">可点击下方示例按钮快速填充示例数据</div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-secondary w-100" id="fillExample">
                                <i class="fas fa-magic me-1"></i>填充示例数据
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-secondary w-100" id="clearBatchData">
                                <i class="fas fa-trash me-1"></i>清空输入框
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="batchPreview" style="display: none;">
                        <label class="form-label">数据预览</label>
                        <div class="table-responsive preview-table">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>编号</th>
                                        <th>名称</th>
                                        <th>链接</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTable">
                                    <!-- 预览数据将在这里动态生成 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="batchResults" style="display: none;">
                        <!-- 批量添加结果将在这里显示 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="previewBatchData">预览数据</button>
                    <button type="button" class="btn btn-success" id="submitBatchAdd" disabled>执行批量添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑记录模态框 -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>编辑记录</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="mb-3">
                            <label class="form-label">知识库编号</label>
                            <input type="text" class="form-control" id="editKB_Number" disabled>
                            <div class="form-text">主键，不可修改</div>
                        </div>
                        <div class="mb-3">
                            <label for="editKB_Name" class="form-label">知识库名称 *</label>
                            <input type="text" class="form-control" id="editKB_Name" 
                                   name="KB_Name" required placeholder="请输入知识库名称">
                        </div>
                        <div class="mb-3">
                            <label for="editKB_link" class="form-label">链接地址</label>
                            <input type="url" class="form-control" id="editKB_link" 
                                   name="KB_link" placeholder="http://或https://开头">
                            <div class="form-text">可选，请输入完整的URL地址</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitEdit">保存更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>确认删除</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage">确定要删除这条记录吗？此操作不可撤销。</p>
                    <div id="batchDeleteInfo" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            将删除 <span id="selectedCount">0</span> 条记录，请确认！
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 调试信息模态框 -->
    <div class="modal fade" id="debugInfoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="fas fa-bug me-2"></i>系统调试信息</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-cog me-2"></i>调试控制
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="debugModalSwitch">
                                            <label class="form-check-label" for="debugModalSwitch">
                                                启用调试模式
                                            </label>
                                        </div>
                                        <small class="text-muted">调试模式开启后可以查看详细的系统信息</small>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-primary" id="loadDebugInfo">
                                            <i class="fas fa-sync-alt me-1"></i>刷新调试信息
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="checkSystemHealth">
                                            <i class="fas fa-heartbeat me-1"></i>检查系统健康
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="fas fa-info-circle me-2"></i>系统状态
                                </div>
                                <div class="card-body">
                                    <div id="systemStatusInfo">
                                        <div class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                            <p>正在检查系统状态...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-database me-2"></i>详细调试信息</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleDebugDetails">
                                    <i class="fas fa-chevron-down me-1"></i>展开/收起
                                </button>
                            </div>
                            <div class="card-body" id="debugDetails" style="display: none;">
                                <div class="position-relative">
                                    <div class="text-center py-4" id="debugLoading">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                        <p>正在加载调试信息...</p>
                                    </div>
                                    <pre id="debugInfoContent" style="max-height: 400px; overflow-y: auto; display: none;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="copyDebugInfo">
                        <i class="fas fa-copy me-1"></i>复制信息
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统状态详情模态框 -->
    <div class="modal fade" id="systemStatusModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-heartbeat me-2"></i>系统状态详情</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="systemStatusContent">
                        <!-- 系统状态信息将在这里动态生成 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息提示 -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="messageToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2"></i>
                <strong class="me-auto">系统提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // 检查登录状态
            function checkLoginStatus() {
                $.ajax({
                    url: '/auth/check-login',
                    method: 'GET',
                    success: function(response) {
                        if (!response.success) {
                            // 未登录，跳转到登录页面
                            window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
                        }
                    },
                    error: function() {
                        // 网络错误，跳转到登录页面
                        window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
                    }
                });
            }

            // 检查当前是否在管理页面
            if (window.location.pathname === '/MGMT' || 
                window.location.pathname.includes('/api/') && 
                !window.location.pathname.includes('/api/all') &&
                !window.location.pathname.includes('/api/stats')) {
                checkLoginStatus();
            }

            // 全选/取消全选
            $('#selectAll').on('click', function() {
                const isChecked = $(this).prop('checked');
                $('.row-select').prop('checked', isChecked);
                updateSelection();
            });

            // 行选择变化
            $(document).on('change', '.row-select', function() {
                updateSelection();
            });

            // 更新选择状态
            function updateSelection() {
                const selectedCount = $('.row-select:checked').length;
                const totalCount = $('.row-select').length;
                
                $('#selectedCount').text(selectedCount);
                $('#selectAll').prop('checked', selectedCount === totalCount && totalCount > 0);
                
                // 更新按钮状态
                const deleteBtn = $('#deleteSelected');
                const batchDeleteBtn = $('#batchDeleteBtn');
                
                if (selectedCount > 0) {
                    deleteBtn.prop('disabled', false);
                    batchDeleteBtn.prop('disabled', false);
                } else {
                    deleteBtn.prop('disabled', true);
                    batchDeleteBtn.prop('disabled', true);
                }
            }

            // 刷新表格数据
            function reloadTableData() {
                $.ajax({
                    url: '/api/all',
                    method: 'GET',
                    success: function(response) {
                        if (response.success) {
                            // 重新加载页面以更新数据
                            location.reload();
                        } else {
                            showMessage('刷新数据失败: ' + response.message, 'error');
                        }
                    },
                    error: function() {
                        showMessage('网络错误，请稍后重试', 'error');
                    }
                });
            }

            // 添加记录
            $('#submitAdd').on('click', function() {
                const formData = {
                    KB_Number: $('#addKB_Number').val(),
                    KB_Name: $('#addKB_Name').val(),
                    KB_link: $('#addKB_link').val()
                };

                if (!formData.KB_Number || !formData.KB_Name) {
                    showMessage('请填写必填字段', 'warning');
                    return;
                }

                $.ajax({
                    url: '/MGMT/api/add',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, 'success');
                            $('#addModal').modal('hide');
                            $('#addForm')[0].reset();
                            reloadTableData();
                        } else {
                            showMessage(response.message, 'error');
                        }
                    },
                    error: function() {
                        showMessage('网络错误，请稍后重试', 'error');
                    }
                });
            });

            // 批量添加功能
            // 填充示例数据
            $('#fillExample').on('click', function() {
                const exampleData = `1001,云户知识库常见问题解答,https://kb.example.com/faq
1002,云户CRM系统安装指南,https://kb.example.com/install
1003,云户ERP系统故障排除,https://kb.example.com/troubleshoot
1004,用户权限管理指南
1005,数据备份与恢复方案,https://kb.example.com/backup
1006,系统升级流程说明
1007,API接口使用文档,https://kb.example.com/api
1008,移动端App使用指南`;
                
                $('#batchData').val(exampleData);
                $('#batchPreview').hide();
                $('#submitBatchAdd').prop('disabled', true);
            });

            // 清空批量数据输入框
            $('#clearBatchData').on('click', function() {
                $('#batchData').val('');
                $('#batchPreview').hide();
                $('#batchResults').hide();
                $('#submitBatchAdd').prop('disabled', true);
            });

            // 预览批量数据
            $('#previewBatchData').on('click', function() {
                const batchData = $('#batchData').val().trim();
                
                if (!batchData) {
                    showMessage('请输入批量数据', 'warning');
                    return;
                }
                
                const lines = batchData.split('\n').filter(line => line.trim() !== '');
                const previewData = [];
                let hasError = false;
                let errorMessages = [];
                
                // 解析每一行数据
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const parts = line.split(',').map(part => part.trim());
                    
                    if (parts.length < 2) {
                        errorMessages.push(`第${i + 1}行：格式错误，至少需要编号和名称`);
                        hasError = true;
                        continue;
                    }
                    
                    const record = {
                        KB_Number: parts[0],
                        KB_Name: parts[1],
                        KB_link: parts[2] || ''
                    };
                    
                    // 验证编号是否为数字
                    if (!/^\d+$/.test(record.KB_Number)) {
                        errorMessages.push(`第${i + 1}行：知识库编号必须为数字`);
                        hasError = true;
                        continue;
                    }
                    
                    previewData.push(record);
                }
                
                if (hasError) {
                    // 显示错误信息
                    $('#batchPreview').hide();
                    $('#batchResults').html(`
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>数据格式错误：</h6>
                            <ul class="mb-0">
                                ${errorMessages.map(msg => `<li>${msg}</li>`).join('')}
                            </ul>
                        </div>
                    `).show();
                    $('#submitBatchAdd').prop('disabled', true);
                } else {
                    // 显示预览表格
                    let previewHtml = '';
                    previewData.forEach((record, index) => {
                        previewHtml += `
                            <tr>
                                <td>${record.KB_Number}</td>
                                <td>${record.KB_Name}</td>
                                <td>${record.KB_link || '<span class="text-muted">无链接</span>'}</td>
                            </tr>
                        `;
                    });
                    
                    $('#previewTable').html(previewHtml);
                    $('#batchPreview').show();
                    $('#batchResults').hide();
                    $('#submitBatchAdd').prop('disabled', false).data('records', previewData);
                    
                    showMessage(`成功解析 ${previewData.length} 条记录，可以执行添加操作`, 'success');
                }
            });

            // 执行批量添加
            $('#submitBatchAdd').on('click', function() {
                const records = $(this).data('records');
                
                if (!records || records.length === 0) {
                    showMessage('没有可添加的记录', 'warning');
                    return;
                }
                
                // 禁用按钮，显示加载状态
                const $btn = $(this);
                const originalText = $btn.html();
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>正在添加...');
                
                $.ajax({
                    url: '/MGMT/api/batch-add',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ records: records }),
                    success: function(response) {
                        if (response.success) {
                            // 显示详细结果
                            let resultsHtml = `
                                <div class="alert alert-success">
                                    <h5><i class="fas fa-check-circle me-2"></i>${response.message}</h5>
                                    <p>总计：${response.summary.total} 条</p>
                                    <p>成功：<span class="text-success">${response.summary.success} 条</span></p>
                                    <p>跳过重复：<span class="text-warning">${response.summary.duplicate} 条</span></p>
                                    <p>失败：<span class="text-danger">${response.summary.failed} 条</span></p>
                                </div>
                            `;
                            
                            // 如果有失败记录，显示详细信息
                            if (response.failed_records && response.failed_records.length > 0) {
                                resultsHtml += `
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-exclamation-circle me-2"></i>失败的记录：</h6>
                                        <div class="table-responsive mt-2">
                                            <table class="table table-sm table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th width="80">编号</th>
                                                        <th>名称</th>
                                                        <th>链接</th>
                                                        <th>失败原因</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                `;
                                
                                response.failed_records.forEach(item => {
                                    resultsHtml += `
                                        <tr>
                                            <td>${item.record.KB_Number}</td>
                                            <td>${item.record.KB_Name}</td>
                                            <td>${item.record.KB_link || '<span class="text-muted">无</span>'}</td>
                                            <td class="text-danger">${item.reason}</td>
                                        </tr>
                                    `;
                                });
                                
                                resultsHtml += `
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            $('#batchResults').html(resultsHtml).show();
                            showMessage(response.message, 'success');
                            
                            // 如果成功添加了记录，刷新表格
                            if (response.summary.success > 0) {
                                setTimeout(function() {
                                    reloadTableData();
                                }, 2000);
                            }
                        } else {
                            showMessage(response.message, 'error');
                        }
                        
                        // 恢复按钮状态
                        $btn.prop('disabled', false).html(originalText);
                    },
                    error: function() {
                        showMessage('网络错误，请稍后重试', 'error');
                        // 恢复按钮状态
                        $btn.prop('disabled', false).html(originalText);
                    }
                });
            });

            // 批量添加模态框显示时重置状态
            $('#batchAddModal').on('show.bs.modal', function() {
                $('#batchPreview').hide();
                $('#batchResults').hide();
                $('#submitBatchAdd').prop('disabled', true);
            });

            // 编辑记录
            let currentEditId = null;
            $(document).on('click', '.btn-edit', function() {
                currentEditId = $(this).data('id');
                $('#editKB_Number').val('KB_' + currentEditId);
                $('#editKB_Name').val($(this).data('name'));
                $('#editKB_link').val($(this).data('link') || '');
                $('#editModal').modal('show');
            });

            $('#submitEdit').on('click', function() {
                const formData = {
                    KB_Name: $('#editKB_Name').val(),
                    KB_link: $('#editKB_link').val()
                };

                if (!formData.KB_Name) {
                    showMessage('知识库名称不能为空', 'warning');
                    return;
                }

                $.ajax({
                    url: '/MGMT/api/update/' + currentEditId,
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, 'success');
                            $('#editModal').modal('hide');
                            reloadTableData();
                        } else {
                            showMessage(response.message, 'error');
                        }
                    },
                    error: function() {
                        showMessage('网络错误，请稍后重试', 'error');
                    }
                });
            });

            // 删除记录（单条）
            let deleteType = 'single'; // 'single' 或 'batch'
            let currentDeleteId = null;
            let selectedIds = [];

            $(document).on('click', '.btn-delete', function() {
                deleteType = 'single';
                currentDeleteId = $(this).data('id');
                $('#deleteMessage').text(`确定要删除编号为 ${currentDeleteId} 的记录吗？此操作不可撤销。`);
                $('#batchDeleteInfo').hide();
                $('#deleteModal').modal('show');
            });

            // 批量删除
            $('#deleteSelected').on('click', function() {
                deleteType = 'batch';
                selectedIds = [];
                $('.row-select:checked').each(function() {
                    selectedIds.push($(this).val());
                });
                
                $('#deleteMessage').text('确定要删除选中的记录吗？');
                $('#selectedCount').text(selectedIds.length);
                $('#batchDeleteInfo').show();
                $('#deleteModal').modal('show');
            });

            // 确认删除
            $('#confirmDelete').on('click', function() {
                if (deleteType === 'single') {
                    $.ajax({
                        url: '/MGMT/api/delete/' + currentDeleteId,
                        method: 'DELETE',
                        success: function(response) {
                            if (response.success) {
                                showMessage(response.message, 'success');
                                $('#deleteModal').modal('hide');
                                reloadTableData();
                            } else {
                                showMessage(response.message, 'error');
                            }
                        },
                        error: function() {
                            showMessage('网络错误，请稍后重试', 'error');
                        }
                    });
                } else if (deleteType === 'batch') {
                    $.ajax({
                        url: '/MGMT/api/batch-delete',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ ids: selectedIds }),
                        success: function(response) {
                            if (response.success) {
                                showMessage(response.message, 'success');
                                $('#deleteModal').modal('hide');
                                reloadTableData();
                            } else {
                                showMessage(response.message, 'error');
                            }
                        },
                        error: function() {
                            showMessage('网络错误，请稍后重试', 'error');
                        }
                    });
                }
            });

            // 导出数据
            $('#exportBtn, #exportData').on('click', function() {
                $.ajax({
                    url: '/MGMT/api/export',
                    method: 'GET',
                    success: function(response) {
                        if (response.success) {
                            // 创建并下载JSON文件
                            const dataStr = JSON.stringify(response.data, null, 2);
                            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                            
                            const exportFileDefaultName = `云户_export_${new Date().toISOString().split('T')[0]}.json`;
                            
                            const linkElement = document.createElement('a');
                            linkElement.setAttribute('href', dataUri);
                            linkElement.setAttribute('download', exportFileDefaultName);
                            linkElement.click();
                            
                            showMessage('数据导出成功，文件已开始下载', 'success');
                        } else {
                            showMessage('导出失败: ' + response.message, 'error');
                        }
                    },
                    error: function() {
                        showMessage('网络错误，请稍后重试', 'error');
                    }
                });
            });

            // 刷新按钮
            $('#refreshData, #reloadTable').on('click', function() {
                reloadTableData();
            });

            // 调试功能
            // 调试模式开关
            $('#debugModeSwitch, #debugModalSwitch').on('change', function() {
                const debugMode = $(this).prop('checked');
                
                $.ajax({
                    url: '/MGMT/api/toggle-debug',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ debug_mode: debugMode }),
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, 'success');
                            // 同步两个开关的状态
                            $('#debugModeSwitch').prop('checked', debugMode);
                            $('#debugModalSwitch').prop('checked', debugMode);
                            $('#debugModeSwitch').next('label').text(debugMode ? '开启' : '关闭');
                            
                            // 如果关闭调试模式，清除调试信息
                            if (!debugMode) {
                                $('#debugInfoContent').hide();
                                $('#debugLoading').show();
                            }
                        } else {
                            showMessage(response.message, 'error');
                            // 恢复开关状态
                            $(this).prop('checked', !debugMode);
                        }
                    },
                    error: function() {
                        showMessage('网络错误，请稍后重试', 'error');
                        $(this).prop('checked', !debugMode);
                    }
                });
            });

            // 显示调试工具
            $('#debugToolsBtn, #showDebugInfo').on('click', function() {
                $('#debugInfoModal').modal('show');
                // 加载系统状态
                checkSystemStatus();
            });

            // 加载调试信息
            $('#loadDebugInfo').on('click', function() {
                loadDebugInfo();
            });

            // 切换调试详情显示
            $('#toggleDebugDetails').on('click', function() {
                $('#debugDetails').toggle();
                const icon = $('#toggleDebugDetails i');
                if ($('#debugDetails').is(':visible')) {
                    icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
                    // 如果详情展开且未加载数据，自动加载
                    if ($('#debugInfoContent').html() === '') {
                        loadDebugInfo();
                    }
                } else {
                    icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
                }
            });

            // 加载调试信息
            function loadDebugInfo() {
                $('#debugInfoContent').hide();
                $('#debugLoading').show();
                
                $.ajax({
                    url: '/MGMT/debug',  // 修改为正确的调试路由
                    method: 'GET',
                    success: function(response) {
                        if (response.success) {
                            // 格式化JSON显示
                            const formattedJson = JSON.stringify(response, null, 2);
                            $('#debugInfoContent').html(highlightJson(formattedJson));
                            $('#debugLoading').hide();
                            $('#debugInfoContent').show();
                        } else {
                            $('#debugLoading').html(`
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    ${response.message}
                                </div>
                            `);
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = '加载调试信息失败';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ': ' + xhr.responseJSON.message;
                        }
                        $('#debugLoading').html(`
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle me-2"></i>
                                ${errorMsg}
                            </div>
                        `);
                    }
                });
            }

            // 检查系统状态
            $('#checkSystemStatus, #checkSystemHealth').on('click', function() {
                checkSystemStatus(true);
            });

            function checkSystemStatus(showModal = false) {
                $.ajax({
                    url: '/MGMT/api/system-status',
                    method: 'GET',
                    success: function(response) {
                        if (response.success) {
                            updateSystemStatusDisplay(response, showModal);
                        } else {
                            showMessage('获取系统状态失败: ' + response.message, 'error');
                        }
                    },
                    error: function() {
                        showMessage('检查系统状态失败，请检查网络连接', 'error');
                    }
                });
            }

            // 更新系统状态显示
            function updateSystemStatusDisplay(status, showModal = false) {
                const healthBadges = {
                    'healthy': '<span class="badge bg-success">健康</span>',
                    'connected_no_data': '<span class="badge bg-warning">无数据</span>',
                    'database_error': '<span class="badge bg-danger">数据库错误</span>'
                };
                
                const healthTexts = {
                    'healthy': '系统运行正常，所有组件正常工作',
                    'connected_no_data': '数据库连接正常，但未发现数据记录',
                    'database_error': '数据库连接失败，请检查配置',
                    'unknown': '系统状态未知'
                };
                
                const healthIcon = status.system_health === 'healthy' ? 'fa-check-circle' : 
                                status.system_health === 'connected_no_data' ? 'fa-exclamation-triangle' : 'fa-times-circle';
                
                const statusHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6>系统健康状态</h6>
                                <div class="d-flex align-items-center">
                                    <i class="fas ${healthIcon} fa-2x ${status.system_health === 'healthy' ? 'text-success' : 
                                    status.system_health === 'connected_no_data' ? 'text-warning' : 'text-danger'} me-3"></i>
                                    <div>
                                        <h5>${healthBadges[status.system_health] || '<span class="badge bg-secondary">未知</span>'}</h5>
                                        <p class="mb-0">${healthTexts[status.system_health] || healthTexts.unknown}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6>数据库状态</h6>
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-database fa-2x ${status.database_connected ? 'text-success' : 'text-danger'} me-3"></i>
                                    <div>
                                        <h5>${status.database_connected ? 
                                            '<span class="badge bg-success">已连接</span>' : 
                                            '<span class="badge bg-danger">未连接</span>'}</h5>
                                        <p class="mb-0">${status.database_connected ? 
                                            '数据库连接正常' : '数据库连接失败'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">知识库记录</h6>
                                    <h3 class="text-primary">${status.total_records}</h3>
                                    ${status.latest_record_time ? 
                                        `<small class="text-muted">最近更新: ${status.latest_record_time}</small>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">用户数量</h6>
                                    <h3 class="text-primary">${status.user_count}</h3>
                                    ${status.current_user ? 
                                        `<small class="text-muted">当前用户: ${status.current_user.username}</small>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">检查时间</h6>
                                    <h5 class="text-success">${status.timestamp}</h5>
                                    <small class="text-muted">系统运行正常</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#systemStatusInfo').html(statusHtml);
                
                // 如果需要显示模态框
                if (showModal) {
                    $('#systemStatusContent').html(`
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            系统状态检查完成于 ${status.timestamp}
                        </div>
                        ${statusHtml}
                        ${status.database_error ? `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                数据库错误: ${status.database_error}
                            </div>
                        ` : ''}
                    `);
                    $('#systemStatusModal').modal('show');
                }
            }

            // 系统清理
            $('#systemCleanup').on('click', function() {
                if (!confirm('确定要执行系统清理吗？这将清除临时数据和缓存。')) {
                    return;
                }
                
                $.ajax({
                    url: '/MGMT/api/cleanup',
                    method: 'POST',
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message, 'success');
                        } else {
                            showMessage(response.message, 'error');
                        }
                    },
                    error: function() {
                        showMessage('清理失败，请稍后重试', 'error');
                    }
                });
            });

            // 复制调试信息
            $('#copyDebugInfo').on('click', function() {
                const debugText = $('#debugInfoContent').text();
                if (debugText) {
                    navigator.clipboard.writeText(debugText)
                        .then(() => showMessage('调试信息已复制到剪贴板', 'success'))
                        .catch(() => showMessage('复制失败，请手动复制', 'error'));
                } else {
                    showMessage('没有可复制的调试信息', 'warning');
                }
            });

            // JSON语法高亮
            function highlightJson(json) {
                // 简单的JSON语法高亮
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, 
                    function(match) {
                        let cls = 'text-primary'; // 键名
                        if (/^"/.test(match)) {
                            if (/:$/.test(match)) {
                                cls = 'text-dark'; // 键名
                            } else {
                                cls = 'text-success'; // 字符串值
                            }
                        } else if (/true|false/.test(match)) {
                            cls = 'text-warning'; // 布尔值
                        } else if (/null/.test(match)) {
                            cls = 'text-danger'; // null值
                        } else if (/^-?\d+/.test(match)) {
                            cls = 'text-info'; // 数字
                        }
                        return '<span class="' + cls + '">' + match + '</span>';
                    });
            }

            // 重新加载页面
            $('#reloadPage').on('click', function() {
                location.reload();
            });

            // 显示消息
            function showMessage(message, type = 'info') {
                const toastEl = $('#messageToast');
                const toastMessage = $('#toastMessage');
                const header = toastEl.find('.toast-header');
                
                // 设置图标和颜色
                let icon = 'fa-info-circle';
                let bgColor = 'bg-info';
                
                switch(type) {
                    case 'success':
                        icon = 'fa-check-circle';
                        bgColor = 'bg-success';
                        break;
                    case 'error':
                        icon = 'fa-times-circle';
                        bgColor = 'bg-danger';
                        break;
                    case 'warning':
                        icon = 'fa-exclamation-triangle';
                        bgColor = 'bg-warning';
                        break;
                }
                
                header.find('i').removeClass().addClass(`fas ${icon} me-2`);
                header.removeClass().addClass(`toast-header text-white ${bgColor}`);
                toastMessage.text(message);
                
                const toast = new bootstrap.Toast(toastEl[0]);
                toast.show();
            }

            // 初始化选择状态
            updateSelection();
            
            // 页面加载时检查系统状态
            setTimeout(() => {
                checkSystemStatus();
            }, 1000);
        });
    </script>
</body>
</html>