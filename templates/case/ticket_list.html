<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工单列表 - 工单系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css?v=5.3.0" rel="stylesheet">
    <link rel="stylesheet" href="/static/common.css?v=2.0">
    <link rel="stylesheet" href="/static/case/css/style.css?v=2.0">
    <style>
        body {
            background: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .top-nav {
            background: white;
            box-shadow: var(--shadow-md);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--gray-200);
        }
        .top-nav img {
            height: 50px;
            width: auto;
            display: block;
            margin: 0 auto;
        }
        .page-header h1 {
            color: #1a202c;
            font-weight: 700;
            font-size: 1.75rem;
        }
        .ticket-card h3 {
            color: #1a202c;
            font-weight: 600;
            font-size: 1.25rem;
        }
        .main-container {
            margin-top: 100px;
            padding: 0 2rem 3rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .page-header h1 {
            margin: 0;
            color: var(--gray-800);
            font-weight: 700;
        }
        .filter-bar {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--gray-600);
        }
        .filter-btn.active,
        .filter-btn:hover {
            background: linear-gradient(135deg, #1a5c9e 0%, #2563eb 100%);
            color: white;
            border-color: #2563eb;
        }
        .ticket-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 4px solid var(--gray-300);
        }
        .ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .ticket-card.priority-urgent {
            border-left-color: var(--danger);
        }
        .ticket-card.priority-high {
            border-left-color: var(--warning);
        }
        .ticket-card.priority-medium {
            border-left-color: var(--info);
        }
        .ticket-card.priority-low {
            border-left-color: var(--success);
        }
        .badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
        }
        .badge-pending { background: var(--warning); color: white; }
        .badge-processing { background: var(--info); color: white; }
        .badge-completed { background: var(--success); color: white; }
        .badge-closed { background: var(--gray-500); color: white; }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--gray-300);
            color: var(--gray-600);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }
        .btn-outline:hover {
            border-color: var(--danger);
            color: var(--danger);
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <div class="top-nav">
        <img src="/static/home/images/Logo1.jpg" alt="云户科技" style="display: block; margin: 0 auto;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span id="welcomeText" style="color: var(--gray-700); font-weight: 500;">欢迎</span>
            <button onclick="logout()" class="btn-outline">退出</button>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="main-container">
        <div class="page-header">
            <h1 id="pageTitle">我的工单</h1>
            <a href="/case/submit_ticket" id="createTicketBtn" class="btn btn-primary" style="display: none;">
                <i class="fas fa-plus me-2"></i>创建新工单
            </a>
        </div>

        <!-- 筛选按钮 -->
        <div class="filter-bar">
            <button class="filter-btn active" data-status="">全部</button>
            <button class="filter-btn" data-status="pending">待处理</button>
            <button class="filter-btn" data-status="processing">处理中</button>
            <button class="filter-btn" data-status="completed">已完成</button>
            <button class="filter-btn" data-status="closed">已关闭</button>
            <button class="filter-btn" id="myTicketsBtn" style="display: none;">我的工单</button>
        </div>

        <!-- 工单列表 -->
        <div id="ticketList">
            <!-- 动态加载工单列表 -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let currentUser = null;
        let currentUserRole = null;
        let currentFilter = '';

        // 检查登录状态
        async function checkLogin() {
            try {
                const response = await axios.get('/case/api/user/info');
                if (response.data.success) {
                    currentUser = response.data.data;
                    currentUserRole = currentUser.role;
                    document.getElementById('welcomeText').textContent =
                        currentUser.real_name || currentUser.username || currentUser.email;
                    updateUIByRole();
                    return true;
                }
            } catch (error) {
                console.error('获取用户信息失败:', error);
            }
            window.location.href = '/case/';
            return false;
        }

        // 根据角色更新UI
        function updateUIByRole() {
            const pageTitle = document.getElementById('pageTitle');
            const createBtn = document.getElementById('createTicketBtn');
            const myTicketsBtn = document.getElementById('myTicketsBtn');

            if (currentUserRole === 'customer') {
                pageTitle.textContent = '我的工单';
                createBtn.style.display = 'inline-block';
                myTicketsBtn.style.display = 'none';
            } else if (currentUserRole === 'admin' || currentUserRole === 'user') {
                pageTitle.textContent = '工单列表';
                createBtn.style.display = 'inline-block';
                myTicketsBtn.style.display = 'inline-block';
            }
        }

        // 加载工单列表
        async function loadTickets(status = '', myOnly = false) {
            try {
                const params = { status };
                if (myOnly) {
                    params.my_only = true;
                }
                const response = await axios.get('/case/api/tickets', { params });
                if (response.data.code === 200 || response.data.success) {
                    renderTickets(response.data.data || response.data.tickets);
                }
            } catch (error) {
                console.error('加载工单列表失败:', error);
            }
        }

        // 渲染工单列表
        function renderTickets(tickets) {
            const container = document.getElementById('ticketList');
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `
                    <div style="
                        text-align: center;
                        padding: 4rem 2rem;
                        background: white;
                        border-radius: var(--radius-lg);
                        box-shadow: var(--shadow-sm);
                    ">
                        <i class="fas fa-inbox" style="font-size: 4rem; color: var(--gray-300); margin-bottom: 1rem;"></i>
                        <p style="color: var(--gray-500); margin: 0;">暂无工单</p>
                    </div>`;
                return;
            }

            container.innerHTML = tickets.map(ticket => `
                <div class="ticket-card priority-${ticket.priority}" onclick="viewTicket('${ticket.ticket_id}')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1.5rem;">
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.75rem 0; color: var(--gray-800); font-weight: 600;">
                                ${ticket.title}
                            </h3>
                            <p style="margin: 0 0 0.75rem 0; color: var(--gray-600); font-size: 0.875rem;">
                                <span class="badge badge-${ticket.status}" style="margin-right: 0.5rem;">
                                    ${getStatusText(ticket.status)}
                                </span>
                                <strong>工单号:</strong> ${ticket.ticket_id} &nbsp;|&nbsp;
                                <strong>产品:</strong> ${ticket.product} &nbsp;|&nbsp;
                                <strong>类型:</strong> ${ticket.issue_type}
                            </p>
                            <p style="margin: 0; color: var(--gray-500); line-height: 1.6;">
                                ${ticket.content.length > 100 ? ticket.content.substring(0, 100) + '...' : ticket.content}
                            </p>
                        </div>
                        <div style="text-align: right; white-space: nowrap;">
                            <p style="margin: 0.5rem 0 0 0; color: var(--gray-400); font-size: 0.75rem;">
                                <i class="far fa-clock me-1"></i>${ticket.create_time || ticket.created_at}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'pending': '待处理',
                'processing': '处理中',
                'completed': '已完成',
                'closed': '已关闭'
            };
            return statusMap[status] || status;
        }

        // 查看工单详情
        function viewTicket(ticketId) {
            window.location.href = `/case/ticket_detail?id=${ticketId}`;
        }

        // 筛选工单
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                const status = this.dataset.status;
                const myOnly = this.id === 'myTicketsBtn';
                loadTickets(status, myOnly);
            });
        });

        // 退出登录
        async function logout() {
            if (confirm('确定要退出登录吗？')) {
                try {
                    await axios.post('/case/api/logout');
                    window.location.href = '/case/';
                } catch (error) {
                    console.error('退出失败:', error);
                }
            }
        }

        // 初始化
        if (checkLogin()) {
            loadTickets();
        }
    </script>
</body>
</html>
