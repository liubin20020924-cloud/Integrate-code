<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统一用户管理 - 云户科技</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css?v=5.3.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css?v=1.10.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='common.css') }}?v=2.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='kb/css/style.css') }}?v=2.0">
    <style>
        /* 统一用户管理页面特定样式 */
        body {
            background-color: #f7fafc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #1a5c9e 0%, #2563eb 100%);
            box-shadow: 0 2px 8px rgba(26, 92, 158, 0.15);
        }
        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }
        .nav-link {
            color: rgba(255,255,255,0.85) !important;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            color: white !important;
        }
        .card {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .card-header {
            background: linear-gradient(135deg, #1a5c9e 0%, #2563eb 100%);
            color: white;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }
        .stats-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #1a5c9e 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stats-label {
            color: var(--gray-600);
            margin-top: 0.5rem;
            font-weight: 500;
        }
        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e8e8e8;
            font-weight: 600;
            color: var(--gray-800);
        }
        .table tbody tr {
            transition: background-color 0.2s ease;
        }
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .badge-role-admin {
            background-color: var(--danger);
        }
        .badge-role-user {
            background-color: var(--primary);
        }
        .badge-role-customer {
            background-color: var(--success);
        }
        .badge-status-active {
            background-color: var(--success);
        }
        .badge-status-inactive {
            background-color: var(--gray-500);
        }
        .badge-status-locked {
            background-color: var(--danger);
        }
        .badge-unified {
            background-color: var(--warning);
            color: #000;
        }
        .system-badge {
            font-size: 0.8em;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
        }
        .btn-primary {
            background: linear-gradient(135deg, #1a5c9e 0%, #2563eb 100%);
            border: none;
            border-radius: var(--radius-md);
            padding: 0.625rem 1.25rem;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #1550a0 0%, #1d5be0 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .nav-tabs .nav-link {
            color: var(--gray-700);
            border: none;
            border-bottom: 3px solid transparent;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .nav-tabs .nav-link.active {
            background-color: white;
            border-bottom: 3px solid #2563eb;
            color: #2563eb;
        }
        .nav-tabs .nav-link:hover {
            border-bottom: 3px solid #2563eb;
            color: #2563eb;
        }
        .modal-header {
            background: linear-gradient(135deg, #1a5c9e 0%, #2563eb 100%);
            color: white;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
        }
        .modal-header .btn-close {
            color: white;
            opacity: 0.8;
        }
        .modal-header .btn-close:hover {
            opacity: 1;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .action-buttons .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }
        .action-buttons .btn:hover {
            transform: translateY(-1px);
        }
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-xl);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shield-lock-fill"></i> 云户科技 - 统一用户管理
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/kb/auth/users">用户管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/kb/MGMT/">知识库管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/case">工单系统</a>
                    </li>
                </ul>
                <span class="navbar-text">
                    欢迎，{{ current_user.display_name or current_user.username }}
                    <a href="/kb/auth/logout" class="btn btn-sm btn-outline-light ms-2">退出</a>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- 错误提示 -->
        {% if error %}
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i> {{ error }}
        </div>
        {% endif %}

        <!-- 用户统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="users-total">-</div>
                    <div class="stats-label">总用户数</div>
                    <small class="text-muted">活跃: <span id="users-active">-</span></small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="users-admins">-</div>
                    <div class="stats-label">管理员</div>
                    <small class="text-muted">普通用户: <span id="users-kb-users">-</span></small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="users-customers">-</div>
                    <div class="stats-label">客户</div>
                    <small class="text-muted">工单系统用户</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number text-danger" id="login-failed">-</div>
                    <div class="stats-label">登录失败次数</div>
                    <small class="text-muted">今日: <span id="login-today">-</span></small>
                </div>
            </div>
        </div>

        <!-- 用户管理标签页 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-people-fill"></i> 用户管理</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="userTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="kb-tab" data-bs-toggle="tab" data-bs-target="#kb-users" type="button">
                            <i class="bi bi-book"></i> 知识库用户
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="case-tab" data-bs-toggle="tab" data-bs-target="#case-users" type="button">
                            <i class="bi bi-ticket-detailed"></i> 工单系统用户
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="userTabsContent">
                    <!-- 知识库用户 -->
                    <div class="tab-pane fade show active" id="kb-users">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>知识库用户列表</h6>
                            <button class="btn btn-primary" onclick="showAddKbUserModal()">
                                <i class="bi bi-plus-circle"></i> 添加用户
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="kb-users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>用户名</th>
                                        <th>显示名称</th>
                                        <th>角色</th>
                                        <th>邮箱</th>
                                        <th>状态</th>
                                        <th>密码类型</th>
                                        <th>最后登录</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="9" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 工单系统用户 -->
                    <div class="tab-pane fade" id="case-users">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>工单系统用户列表</h6>
                            <button class="btn btn-primary" onclick="showAddCaseUserModal()">
                                <i class="bi bi-plus-circle"></i> 添加用户
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="case-users-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>用户名</th>
                                        <th>真实姓名</th>
                                        <th>角色</th>
                                        <th>邮箱</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加知识库用户模态框 -->
    <div class="modal fade" id="addKbUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加知识库用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addKbUserForm">
                        <div class="mb-3">
                            <label class="form-label">用户名 *</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">密码 *</label>
                            <input type="password" class="form-control" name="password" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">显示名称</label>
                            <input type="text" class="form-control" name="display_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">角色</label>
                            <select class="form-select" name="role">
                                <option value="user">普通用户</option>
                                <option value="admin">管理员</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">邮箱</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">状态</label>
                            <select class="form-select" name="status">
                                <option value="active">活跃</option>
                                <option value="inactive">未激活</option>
                                <option value="locked">锁定</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addKbUser()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑知识库用户模态框 -->
    <div class="modal fade" id="editKbUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑知识库用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editKbUserForm">
                        <input type="hidden" name="user_id">
                        <div class="mb-3">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-control" name="username" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">新密码（留空不修改）</label>
                            <input type="password" class="form-control" name="password" minlength="6">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">显示名称</label>
                            <input type="text" class="form-control" name="display_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">真实姓名</label>
                            <input type="text" class="form-control" name="real_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">角色</label>
                            <select class="form-select" name="role">
                                <option value="user">普通用户</option>
                                <option value="admin">管理员</option>
                                <option value="customer">客户</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">邮箱</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">状态</label>
                            <select class="form-select" name="status">
                                <option value="active">活跃</option>
                                <option value="inactive">未激活</option>
                                <option value="locked">锁定</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateKbUser()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加工单系统用户模态框 -->
    <div class="modal fade" id="addCaseUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加工单系统用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCaseUserForm">
                        <div class="mb-3">
                            <label class="form-label">用户名 *</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">密码 *</label>
                            <input type="password" class="form-control" name="password" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">真实姓名</label>
                            <input type="text" class="form-control" name="real_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">角色</label>
                            <select class="form-select" name="role">
                                <option value="customer">客户</option>
                                <option value="admin">管理员</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">邮箱 *</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addCaseUser()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑工单系统用户模态框 -->
    <div class="modal fade" id="editCaseUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑工单系统用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCaseUserForm">
                        <input type="hidden" name="user_id">
                        <div class="mb-3">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-control" name="username" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">新密码（留空不修改）</label>
                            <input type="password" class="form-control" name="password" minlength="6">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">真实姓名</label>
                            <input type="text" class="form-control" name="real_name">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">角色</label>
                            <select class="form-select" name="role">
                                <option value="customer">客户</option>
                                <option value="admin">管理员</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">邮箱</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateCaseUser()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast-container">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <strong class="me-auto" id="toast-title">提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-message"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 添加加载状态提示
        function showLoadingState() {
            const loadingHtml = `
                <div id="loading-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px 50px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem; border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; animation: spinner-border 0.75s linear infinite;"></div>
                        <p style="margin-top: 15px; font-weight: 500; color: #6b7280;">加载数据中...</p>
                    </div>
                </div>
                <style>
                    @keyframes spinner-border {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.insertAdjacentHTML('beforeend', loadingHtml);
        }

        function hideLoadingState() {
            const loading = document.getElementById('loading-overlay');
            if (loading) loading.remove();
        }

        // 加载知识库用户（添加缓存控制）
        async function loadKbUsers() {
            try {
                const response = await fetch('/unified/api/kb-users', {
                    cache: 'no-cache',  // 禁用缓存，获取最新数据
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();

                if (result.success) {
                    const tbody = document.querySelector('#kb-users-table tbody');
                    tbody.innerHTML = result.data.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.display_name || '-'}</td>
                            <td><span class="badge badge-role-${user.role}">${user.role === 'admin' ? '管理员' : (user.role === 'customer' ? '客户' : '用户')}</span></td>
                            <td>${user.email || '-'}</td>
                            <td><span class="badge badge-status-${user.status}">${user.status}</span></td>
                            <td><span class="badge bg-secondary">${user.password_type?.toUpperCase() || '-'}</span></td>
                            <td>${user.last_login ? new Date(user.last_login).toLocaleString('zh-CN') : '-'}</td>
                            <td>${new Date(user.created_at).toLocaleString('zh-CN')}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-primary" onclick="editKbUser(${user.id}, '${user.username}', '${(user.display_name || '').replace(/'/g, "\\'")}', '${user.role}', '${(user.email || '').replace(/'/g, "\\'")}', '${user.status}', '${(user.real_name || '').replace(/'/g, "\\'")}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteKbUser(${user.id}, '${user.username}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    showToast('加载失败', result.message, 'error');
                }
            } catch (error) {
                console.error('加载知识库用户失败:', error);
            }
        }

        // 加载工单系统用户（添加缓存控制）
        async function loadCaseUsers() {
            try {
                const response = await fetch('/unified/api/case-users', {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();

                if (result.success) {
                    const tbody = document.querySelector('#case-users-table tbody');
                    tbody.innerHTML = result.data.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.username}</td>
                            <td>${user.real_name || user.display_name || '-'}</td>
                            <td><span class="badge badge-role-${user.role}">${user.role === 'admin' ? '管理员' : '客户'}</span></td>
                            <td>${user.email || '-'}</td>
                            <td>${new Date(user.created_at).toLocaleString('zh-CN')}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-primary" onclick="editCaseUser(${user.id}, '${user.username}', '${(user.real_name || '').replace(/'/g, "\\'")}', '${user.role}', '${(user.email || '').replace(/'/g, "\\'")}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteCaseUser(${user.id}, '${user.username}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    showToast('加载失败', result.message, 'error');
                }
            } catch (error) {
                console.error('加载工单系统用户失败:', error);
            }
        }

        // 加载用户统计（添加缓存控制）
        async function loadUserStats() {
            try {
                const response = await fetch('/unified/api/user-stats', {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    document.getElementById('users-total').textContent = data.users.total;
                    document.getElementById('users-active').textContent = data.users.active;
                    document.getElementById('users-admins').textContent = data.users.admins;
                    document.getElementById('users-kb-users').textContent = data.users.kb_users;
                    document.getElementById('users-customers').textContent = data.users.customers;
                    document.getElementById('login-failed').textContent = data.login_logs.failed;
                    document.getElementById('login-today').textContent = data.login_logs.today;
                }
            } catch (error) {
                console.error('加载用户统计失败:', error);
            }
        }

        // 显示添加知识库用户模态框
        function showAddKbUserModal() {
            document.getElementById('addKbUserForm').reset();
            new bootstrap.Modal(document.getElementById('addKbUserModal')).show();
        }

        // 添加知识库用户
        async function addKbUser() {
            const form = document.getElementById('addKbUserForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/unified/api/kb-users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    showToast('成功', result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addKbUserModal')).hide();
                    loadKbUsers();
                    loadUserStats();
                } else {
                    showToast('失败', result.message, 'error');
                }
            } catch (error) {
                showToast('错误', '添加用户失败', 'error');
            }
        }

        // 编辑知识库用户
        function editKbUser(id, username, display_name, role, email, status, real_name) {
            const form = document.getElementById('editKbUserForm');
            form.user_id.value = id;
            form.username.value = username;
            form.display_name.value = display_name;
            form.real_name.value = real_name || '';
            form.role.value = role;
            form.email.value = email;
            form.status.value = status;
            form.password.value = '';
            new bootstrap.Modal(document.getElementById('editKbUserModal')).show();
        }

        // 更新知识库用户
        async function updateKbUser() {
            const form = document.getElementById('editKbUserForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            if (!data.password) {
                delete data.password;
            }

            try {
                const response = await fetch(`/unified/api/kb-users/${data.user_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    showToast('成功', result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editKbUserModal')).hide();
                    loadKbUsers();
                    loadUserStats();
                } else {
                    showToast('失败', result.message, 'error');
                }
            } catch (error) {
                showToast('错误', '更新用户失败', 'error');
            }
        }

        // 删除知识库用户
        async function deleteKbUser(id, username) {
            if (!confirm(`确定要删除用户 "${username}" 吗？`)) return;

            try {
                const response = await fetch(`/unified/api/kb-users/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    showToast('成功', result.message, 'success');
                    loadKbUsers();
                    loadUserStats();
                } else {
                    showToast('失败', result.message, 'error');
                }
            } catch (error) {
                showToast('错误', '删除用户失败', 'error');
            }
        }

        // 显示添加工单系统用户模态框
        function showAddCaseUserModal() {
            document.getElementById('addCaseUserForm').reset();
            new bootstrap.Modal(document.getElementById('addCaseUserModal')).show();
        }

        // 添加工单系统用户
        async function addCaseUser() {
            const form = document.getElementById('addCaseUserForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/unified/api/case-users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    showToast('成功', result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addCaseUserModal')).hide();
                    loadCaseUsers();
                    loadUserStats();
                } else {
                    showToast('失败', result.message, 'error');
                }
            } catch (error) {
                showToast('错误', '添加用户失败', 'error');
            }
        }

        // 编辑工单系统用户
        function editCaseUser(id, username, real_name, role, email) {
            const form = document.getElementById('editCaseUserForm');
            form.user_id.value = id;
            form.username.value = username;
            form.real_name.value = real_name;
            form.role.value = role;
            form.email.value = email;
            form.password.value = '';
            new bootstrap.Modal(document.getElementById('editCaseUserModal')).show();
        }

        // 更新工单系统用户
        async function updateCaseUser() {
            const form = document.getElementById('editCaseUserForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            if (!data.password) {
                delete data.password;
            }

            try {
                const response = await fetch(`/unified/api/case-users/${data.user_id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success) {
                    showToast('成功', result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editCaseUserModal')).hide();
                    loadCaseUsers();
                    loadUserStats();
                } else {
                    showToast('失败', result.message, 'error');
                }
            } catch (error) {
                showToast('错误', '更新用户失败', 'error');
            }
        }

        // 删除工单系统用户
        async function deleteCaseUser(id, username) {
            if (!confirm(`确定要删除用户 "${username}" 吗？`)) return;

            try {
                const response = await fetch(`/unified/api/case-users/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    showToast('成功', result.message, 'success');
                    loadCaseUsers();
                    loadUserStats();
                } else {
                    showToast('失败', result.message, 'error');
                }
            } catch (error) {
                showToast('错误', '删除用户失败', 'error');
            }
        }

        // 显示 Toast 通知
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');

            toastTitle.textContent = title;
            toastMessage.textContent = message;

            const icon = toast.querySelector('i');
            icon.className = type === 'success' ? 'bi bi-check-circle-fill text-success me-2' : 'bi bi-exclamation-triangle-fill text-danger me-2';

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 显示加载状态
            showLoadingState();

            // 优化：使用 Promise.all 并行加载，减少等待时间
            Promise.all([
                loadKbUsers(),
                loadCaseUsers(),
                loadUserStats()
            ]).then(() => {
                // 所有数据加载完成后隐藏加载状态
                hideLoadingState();
            }).catch(() => {
                // 即使出错也隐藏加载状态
                hideLoadingState();
            });

            // 标签切换事件
            document.querySelectorAll('#userTabs button').forEach(button => {
                button.addEventListener('shown.bs.tab', function(event) {
                    if (event.target.id === 'kb-tab') {
                        loadKbUsers();
                    } else if (event.target.id === 'case-tab') {
                        loadCaseUsers();
                    }
                });
            });
        });
    </script>
</body>
</html>
