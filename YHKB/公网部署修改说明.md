# 公网部署功能修改说明

## 修改内容

### 需求1：访问index界面时就需要登录
- ✅ 访问首页（`/`）时检查登录状态
- ✅ 未登录用户重定向到登录页面（`/auth/login`）
- ✅ 登录后根据用户角色重定向：
  - 管理员：重定向到后台管理页面（`/MGMT`）
  - 普通用户：重定向到首页（`/`）

### 需求2：后台管理登录中仅允许管理员用户登录
- ✅ 登录时验证用户角色
- ✅ 只有`role='admin'`的用户才能成功登录到后台管理系统
- ✅ 普通用户登录时显示错误提示："普通用户无法登录后台管理系统，请联系管理员"
- ✅ 普通用户登录后重定向到首页而非管理页面

### 需求3：index界面的文件查看功能简化
- ✅ 卡片视图：
  - ❌ 删除"链接地址"显示部分
  - ❌ 删除"访问链接"按钮
  - ❌ 删除"复制链接"按钮
  - ✅ 只保留"查看内容"按钮（有链接时显示）
- ✅ 表格视图：
  - ❌ 删除"链接地址"列
  - ❌ 删除"访问链接"按钮
  - ❌ 删除"复制链接"按钮
  - ✅ 只保留"查看内容"按钮（有链接时显示）
- ✅ 移除JavaScript中的复制链接功能代码

## 修改的文件列表

| 文件 | 修改内容 |
|------|---------|
| `auth/routes.py` | ✅ 登录逻辑修改：增加角色验证，普通用户无法登录后台 |
| `views/routes.py` | ✅ 首页增加登录检查，未登录重定向到登录页；传递current_user到模板 |
| `templates/index.html` | ✅ 移除MGMT跳转链接；新增用户信息栏；简化卡片和表格视图；移除复制链接功能代码 |
| `static/css/style.css` | ✅ 新增.user-info-bar样式 |

## 功能说明

### 用户登录流程

```
1. 访问首页（/）
   ↓
2. 检查登录状态
   ↓
3a. 未登录 → 重定向到 /auth/login
3b. 已登录 → 显示首页内容
```

### 管理员登录流程

```
1. 访问 /auth/login
   ↓
2. 输入用户名密码
   ↓
3a. role='admin' → 成功登录 → 重定向到 /MGMT（后台管理）
3b. role='user' → 显示错误提示 → 无法登录后台
```

### 普通用户登录流程

```
1. 访问 /auth/login
   ↓
2. 输入用户名密码
   ↓
3. 检查角色
   ↓
4a. role='user' → 显示错误："普通用户无法登录后台管理系统，请联系管理员"
4b. role='admin' → 成功登录 → 重定向到首页（/）
```

### 首页用户信息栏

已登录用户会在首页顶部看到：
- 用户名/显示名称
- 用户角色（管理员/用户）
- 退出登录按钮
- 管理后台按钮（仅管理员可见）

### 知识库记录显示

**卡片视图：**
```
┌─────────────────────────┐
│ KB_001            │  ← 卡片标题
│ 知识库名称         │
│                     │
│ [查看内容] 按钮      │  ← 仅此按钮
└─────────────────────────┘
```

**表格视图：**
```
┌─────────────────────────┐
│ 编号  │ 知识库名称  │ 操作      │
├─────────────────────────┤
│ KB_001 │ 数据库管理    │ [查看内容] │  ← 简化为一列
└─────────────────────────┘
```

## 配置要求

### config.py 配置

确保 `config.py` 中配置正确：
```python
# 数据库配置（公网服务器）
DB_HOST = 'your-database-server.com'  # 改为实际数据库地址

# Flask服务器配置
FLASK_HOST = '0.0.0.0'  # 监听所有网卡
FLASK_PORT = 5000           # 服务端口

# Trilium服务器配置
TRILIUM_SERVER_URL = 'http://your-trilium-server.com:8080'
TRILIUM_BASE_URL = 'http://your-trilium-server.com:8080'
TRILIUM_SERVER_HOST = 'your-trilium-server.com:8080'
```

### 数据库要求

确保数据库中有两种角色的用户：
- `admin`：管理员，可以访问后台管理
- `user`：普通用户，只能访问首页查看内容

### 首次运行

1. 系统会自动创建默认管理员账号（如果不存在）
2. 登录后使用 `/auth/users` 添加普通用户
3. 普通用户使用其账号登录可以查看首页
4. 管理员使用admin账号登录可以访问后台管理

## 安全特性

### 1. 访问控制
- 首页需要登录才能访问
- 管理后台仅管理员可访问
- 角色验证在登录时进行

### 2. 会话管理
- 使用Flask session管理用户登录状态
- session包含：user_id, username, display_name, role, login_time
- 退出登录时清空session

### 3. 防止未授权访问
- 所有管理功能使用 `@login_required(roles=['admin'])` 装饰器
- 普通用户尝试访问管理页面会被拒绝
- 返回403权限错误页面

## 测试建议

### 1. 测试未登录访问首页
```bash
# 访问首页
curl http://your-server.com/
# 预期：重定向到登录页面
```

### 2. 测试普通用户登录
```bash
# 使用普通用户登录
# 预期：显示错误提示"普通用户无法登录后台管理系统"
# 登录后：重定向到首页
```

### 3. 测试管理员登录
```bash
# 使用admin账号登录
# 预期：成功登录 → 重定向到 /MGMT
```

### 4. 测试首页功能
```bash
# 登录后访问首页
# 检查：
# - 顶部显示用户信息栏
# - 知识库卡片只显示"查看内容"按钮
# - 表格视图无"链接地址"列
# - 没有复制链接功能
```

## 注意事项

1. **公网部署注意事项**
   - 修改 `config.py` 中的所有服务器地址
   - 确保数据库服务器可访问
   - 确保Trilium服务器可访问
   - 建议修改 `SECRET_KEY` 为随机密钥

2. **用户管理**
   - 使用管理员账号登录
   - 访问 `/auth/users` 管理用户
   - 创建普通用户供日常使用
   - 普通用户无法访问后台管理

3. **功能限制**
   - 首页必须登录后才能访问
   - 知识库链接地址不再显示
   - 无法直接跳转到Trilium链接
   - 无法复制知识库链接
   - 只能通过"查看内容"按钮在模态框中查看

4. **用户体验**
   - 首页顶部显示用户信息，方便退出
   - 管理员可以快速跳转到管理后台
   - 界面更加简洁，只显示必要的操作
