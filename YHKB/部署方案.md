# 云户知识库 - 公网部署方案

## 当前项目状态分析

### 技术栈
- **后端框架**: Flask (Python)
- **前端**: HTML + Bootstrap 5 + jQuery
- **数据库**: MySQL
- **知识库**: Trilium Notes

### 已有功能
- ✅ 用户认证系统（管理员/普通用户）
- ✅ 知识库内容管理
- ✅ 用户管理界面
- ✅ 内容查看功能
- ✅ 响应式设计

---

## 方案一：使用Gunicorn + Nginx（推荐生产环境）

### 1.1 安装依赖

```bash
# 安装Python依赖
pip install gunicorn

# 安装Nginx
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

### 1.2 配置Gunicorn

创建 `gunicorn_config.py`:
```python
import multiprocessing

# 服务器地址
bind = "127.0.0.1:5000"

# 工作进程数（建议2-4个CPU核心）
workers = multiprocessing.cpu_count() * 2 + 1

# 工作模式
worker_class = "sync"

# 每个工作进程的线程数
threads = 2

# 工作进程最大请求数（防止内存泄漏）
max_requests = 1000
max_requests_jitter = 50

# 超时设置
timeout = 120
keepalive = 5

# 日志配置
accesslog = "/var/log/yhkb/gunicorn_access.log"
errorlog = "/var/log/yhkb/gunicorn_error.log"
loglevel = "info"

# 进程名称
proc_name = "yhkb"

# 后台运行
daemon = True

# PID文件
pidfile = "/var/run/yhkb/gunicorn.pid"
```

### 1.3 创建Gunicorn服务文件

创建 `/etc/systemd/system/yhkb.service`:
```ini
[Unit]
Description=Gunicorn instance to serve YHKB
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/path/to/YHKB
Environment="PATH=/path/to/YHKB/venv/bin"
ExecStart=/path/to/YHKB/venv/bin/gunicorn -c gunicorn_config.py app:create_app()
Restart=always

[Install]
WantedBy=multi-user.target
```

### 1.4 配置Nginx

创建 `/etc/nginx/sites-available/yhkb`:
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 修改为你的域名

    # 日志配置
    access_log /var/log/nginx/yhkb_access.log;
    error_log /var/log/nginx/yhkb_error.log;

    # 静态文件处理（提高性能）
    location /static/ {
        alias /path/to/YHKB/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 代理到Gunicorn
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 缓冲区设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }
}
```

### 1.5 启用配置

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/yhkb /etc/nginx/sites-enabled/

# 测试Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 启动Gunicorn服务
sudo systemctl start yhkb
sudo systemctl enable yhkb
```

---

## 方案二：使用Docker容器化部署

### 2.1 创建Dockerfile

创建 `Dockerfile`:
```dockerfile
FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 设置环境变量
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# 复制requirements文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建非root用户
RUN useradd -m appuser && chown -R appuser:appuser /app
USER appuser

# 暴露端口
EXPOSE 5000

# 启动命令
CMD ["gunicorn", "-c", "gunicorn_config.py", "app:create_app()"]
```

### 2.2 创建docker-compose.yml

创建 `docker-compose.yml`:
```yaml
version: '3.8'

services:
  yhkb:
    build: .
    container_name: yhkb-app
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - DB_HOST=10.10.10.254
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=Nutanix/4u123!
      - DB_NAME=YHKB
      - TRILIUM_SERVER_URL=http://10.10.10.254:8080
      - TRILIUM_TOKEN=your_token_here
    volumes:
      - ./logs:/app/logs
    networks:
      - yhkb-network

  nginx:
    image: nginx:alpine
    container_name: yhkb-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./static:/var/www/static:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - yhkb
    networks:
      - yhkb-network

networks:
  yhkb-network:
    driver: bridge
```

### 2.3 构建和运行

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

---

## 方案三：使用CloudBase/Supabase云部署

### 3.1 使用CloudBase（腾讯云）

优势：
- 无需服务器运维
- 自动扩缩容
- 支持微信小程序集成

步骤：
1. 登录腾讯云CloudBase控制台
2. 创建云应用
3. 上传代码或使用Git仓库部署
4. 配置环境变量
5. 绑定自定义域名

### 3.2 使用Supabase

优势：
- 开源免费
- PostgreSQL数据库
- 实时数据库
- Auth认证

步骤：
1. 注册Supabase账号
2. 创建新项目
3. 使用Supabase CLI部署
4. 配置数据库连接

---

## 方案四：使用Gunicorn + Supervisor（简单方案）

### 4.1 安装Supervisor

```bash
sudo apt install supervisor
```

### 4.2 创建Supervisor配置

创建 `/etc/supervisor/conf.d/yhkb.conf`:
```ini
[program:yhkb]
command=/path/to/YHKB/venv/bin/gunicorn -c /path/to/YHKB/gunicorn_config.py app:create_app()
directory=/path/to/YHKB
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/yhkb/supervisor.log
```

### 4.3 启动服务

```bash
# 更新配置
sudo supervisorctl reread
sudo supervisorctl update

# 启动服务
sudo supervisorctl start yhkb

# 查看状态
sudo supervisorctl status
```

---

## SSL/HTTPS配置（推荐）

### 使用Let's Encrypt免费证书

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

### 修改Nginx配置支持HTTPS

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 其他配置保持不变
    # ...
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 部署前检查清单

### 配置文件修改
- [ ] 修改 `config.py` 中的 `SECRET_KEY`
- [ ] 修改 `SECRET_KEY` 为随机密钥：`python -c "import secrets; print(secrets.token_hex(32))"`
- [ ] 修改数据库连接信息
- [ ] 修改Trilium服务器地址
- [ ] 修改默认管理员密码

### 安全设置
- [ ] 启用HTTPS
- [ ] 配置防火墙规则
- [ ] 修改所有默认密码
- [ ] 禁用DEBUG模式
- [ ] 配置日志轮转

### 性能优化
- [ ] 启用静态文件缓存
- [ ] 配置Gunicorn工作进程数
- [ ] 启用Nginx gzip压缩
- [ ] 配置CDN（如果需要）

### 监控告警
- [ ] 配置服务器监控
- [ ] 配置日志告警
- [ ] 配置数据库监控
- [ ] 配置备份策略

---

## 推荐部署流程

### 对于公网服务器（当前情况）

**推荐：方案一（Gunicorn + Nginx）**

```bash
# 1. 创建虚拟环境
python -m venv venv
source venv/bin/activate

# 2. 安装依赖
pip install -r requirements.txt
pip install gunicorn

# 3. 修改配置文件
# 编辑 config.py，修改 SECRET_KEY 和服务器地址

# 4. 创建必要的目录
sudo mkdir -p /var/log/yhkb
sudo mkdir -p /var/run/yhkb
sudo chown -R www-data:www-data /var/log/yhkb
sudo chown -R www-data:www-data /var/run/yhkb

# 5. 配置Gunicorn（参考上方）
# 6. 配置Nginx（参考上方）
# 7. 启动服务

# 8. 测试
curl http://your-domain.com/

# 9. 配置SSL（可选但推荐）
```

---

## 常见问题解决

### 1. 端口被占用
```bash
# 查看端口占用
sudo netstat -tulpn | grep :5000

# 修改配置文件中的端口
```

### 2. 权限问题
```bash
# 修改文件权限
sudo chown -R www-data:www-data /path/to/YHKB
sudo chmod -R 755 /path/to/YHKB
```

### 3. 数据库连接失败
```bash
# 测试数据库连接
mysql -h 10.10.10.254 -u root -p

# 检查防火墙规则
sudo ufw status
```

### 4. Trilium连接失败
```bash
# 测试Trilium连接
curl http://10.10.10.254:8080

# 检查Token是否正确
```

---

## 性能监控建议

### 使用PM2（Node.js工具，也支持Python）
```bash
npm install -g pm2
pm2 start gunicorn --name yhkb -- -c gunicorn_config.py app:create_app()
pm2 save
pm2 startup
```

### 日志监控
```bash
# 查看Gunicorn日志
sudo tail -f /var/log/yhkb/gunicorn_access.log
sudo tail -f /var/log/yhkb/gunicorn_error.log

# 查看Nginx日志
sudo tail -f /var/log/nginx/yhkb_access.log
sudo tail -f /var/log/nginx/yhkb_error.log
```

---

## 总结

对于你的云户知识库项目，推荐使用**方案一（Gunicorn + Nginx）**：

✅ **优势**：
- 成熟稳定，生产环境标准配置
- 性能优异，支持高并发
- 易于维护和扩展
- 支持HTTPS

✅ **适用场景**：
- 已有公网服务器
- 需要稳定生产环境
- 需要高可用性

如果需要完全自动化部署，可以考虑**方案二（Docker）**。
